<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Viewer - Cam 001</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; }
        #viewer-001 { width: 100%; height: 600px; background-color: #f0f0f0; position: relative; }
        .loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #888; font-family: sans-serif; }
    </style>
</head>
<body>

<div id="viewer-001">
    <div class="loader">Loading 360 View...</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    var viewerId = 'viewer-001';
    var imageUrl = 'https://raw.githubusercontent.com/healka/360viewer/master/assets/Cam360-001.png';
    var viewer;

    var observer = new IntersectionObserver(function(entries, self) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                viewer = pannellum.viewer(viewerId, {
                    "type": "equirectangular",
                    "panorama": imageUrl,
                    "autoLoad": true,
                    "autoRotate": -2,
                    "compass": false
                });
                self.unobserve(entry.target);
            }
        });
    }, { rootMargin: "200px" });

    var viewerEl = document.getElementById(viewerId);
    if (viewerEl) observer.observe(viewerEl);

    // iOS 13+ DeviceOrientation permission check
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        var btn = document.createElement('button');
        btn.textContent = 'Enable Motion Control';
        btn.style.cssText = 'position:absolute; bottom:10px; left:50%; transform:translateX(-50%); z-index:9999; padding:10px 20px; background:rgba(0,0,0,0.7); color:white; border:1px solid white; border-radius:4px; font-family:sans-serif; font-size:14px; cursor:pointer; pointer-events:auto;';
        
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Ensure viewer is ready
            if (!viewer) {
                alert('Please wait for the panorama to load completely before enabling motion control.');
                return;
            }

            DeviceOrientationEvent.requestPermission()
                .then(function(response) {
                    if (response === 'granted') {
                        btn.style.display = 'none';
                        try {
                            viewer.startOrientation();
                        } catch (e) {
                            alert('Error starting orientation mode: ' + e);
                        }
                    } else {
                        alert('Permission denied. Please allow motion access to use this feature.');
                    }
                })
                .catch(function(error) {
                    alert('Error requesting permission: ' + error + '\n\nEnsure you are visiting via HTTPS.');
                    console.error(error);
                });
        };
        
        document.getElementById(viewerId).appendChild(btn);
    }
});
</script>

</body>
</html>
